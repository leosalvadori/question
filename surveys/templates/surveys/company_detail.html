{% extends 'base.html' %}

{% block title %}Empresa - {{ company.name }}{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
	<h1 class="text-2xl font-semibold">{{ company.name }}</h1>
	<div class="space-x-2">
		<a href="{% url 'company_update' company.id %}" class="px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:opacity-90">Editar</a>
		<a href="{% url 'company_delete' company.id %}" class="px-4 py-2 bg-destructive text-destructive-foreground rounded-lg hover:opacity-90">Excluir</a>
		<a href="{% url 'company_tokens' company.id %}" class="px-4 py-2 border border-border rounded-lg hover:bg-accent">Tokens JWT</a>
	</div>
</div>

<!-- Quick Action Buttons -->
<div class="mb-6 p-4 rounded-xl glass-effect border border-border/40">
	<h3 class="text-sm font-semibold mb-3">Ações Rápidas</h3>
	<div class="flex flex-wrap gap-2">
		<!-- Contract Actions -->
		{% if not company.is_active %}
		<form method="post" action="{% url 'company_activate' company.id %}" class="inline">
			{% csrf_token %}
			<button type="submit" class="px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
				Ativar Contrato
			</button>
		</form>
		{% else %}
		<form method="post" action="{% url 'company_deactivate' company.id %}" class="inline">
			{% csrf_token %}
			<button type="submit" class="px-3 py-1.5 bg-orange-600 text-white text-sm rounded-lg hover:bg-orange-700">
				Desativar Contrato
			</button>
		</form>
		{% endif %}
		
		<!-- Convert to Client -->
		{% if company.company_type == 'prospect' %}
		<form method="post" action="{% url 'company_convert_to_client' company.id %}" class="inline">
			{% csrf_token %}
			<button type="submit" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">
				Converter para Cliente
			</button>
		</form>
		{% endif %}
		
		<!-- Payment Actions -->
		{% if company.payment_status != 'suspended' %}
		<form method="post" action="{% url 'company_suspend_payment' company.id %}" class="inline">
			{% csrf_token %}
			<button type="submit" class="px-3 py-1.5 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700">
				Suspender por Inadimplência
			</button>
		</form>
		{% else %}
		<form method="post" action="{% url 'company_restore_payment' company.id %}" class="inline">
			{% csrf_token %}
			<button type="submit" class="px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
				Restaurar Pagamento
			</button>
		</form>
		{% endif %}
		
		<!-- Contact History for Prospects -->
		{% if company.company_type == 'prospect' %}
		<a href="{% url 'company_contacts' company.id %}" class="px-3 py-1.5 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700">
			Histórico de Contatos
		</a>
		{% endif %}
	</div>
</div>

<div class="mb-8 space-y-6">
	<!-- Contact Information -->
	{% if company.responsible_person or company.phone or company.cnpj or company.cpf %}
	<div class="p-6 rounded-xl glass-effect border border-border/40">
		<h3 class="text-lg font-semibold mb-4">Informações de Contato</h3>
		<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
			{% if company.responsible_person %}
			<div>
				<p class="text-sm text-muted-foreground">Responsável</p>
				<p class="text-lg font-medium">{{ company.responsible_person }}</p>
			</div>
			{% endif %}
			{% if company.phone %}
			<div>
				<p class="text-sm text-muted-foreground">Telefone</p>
				<p class="text-lg font-medium">{{ company.phone }}</p>
			</div>
			{% endif %}
			{% if company.cnpj %}
			<div>
				<p class="text-sm text-muted-foreground">CNPJ</p>
				<p class="text-lg font-medium">{{ company.cnpj }}</p>
			</div>
			{% endif %}
			{% if company.cpf %}
			<div>
				<p class="text-sm text-muted-foreground">CPF do Responsável</p>
				<p class="text-lg font-medium">{{ company.cpf }}</p>
			</div>
			{% endif %}
		</div>
	</div>
	{% endif %}
	
	<!-- Address -->
	{% if company.street or company.city %}
	<div class="p-6 rounded-xl glass-effect border border-border/40">
		<h3 class="text-lg font-semibold mb-4">Endereço</h3>
		<p class="text-sm">{{ company.full_address }}</p>
	</div>
	{% endif %}
	
	<!-- Status Overview -->
	<div class="p-6 rounded-xl glass-effect border border-border/40">
		<h3 class="text-lg font-semibold mb-4">Status da Empresa</h3>
		<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
			<div>
				<p class="text-sm text-muted-foreground">Tipo</p>
				<p class="text-lg font-medium">
					{% if company.company_type == 'prospect' %}
						<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800">
							{{ company.get_company_type_display }}
						</span>
					{% else %}
						<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
							{{ company.get_company_type_display }}
						</span>
					{% endif %}
				</p>
			</div>
			<div>
				<p class="text-sm text-muted-foreground">Contrato</p>
				<p class="text-lg font-medium">
					{% if company.is_active %}
						<span class="text-green-600">✓ Ativo</span>
					{% else %}
						<span class="text-red-600">✗ Inativo</span>
					{% endif %}
				</p>
			</div>
			<div>
				<p class="text-sm text-muted-foreground">Pagamento</p>
				<p class="text-lg font-medium">
					{% if company.payment_status == 'active' %}
						<span class="text-green-600">{{ company.get_payment_status_display }}</span>
					{% elif company.payment_status == 'overdue' %}
						<span class="text-orange-600">{{ company.get_payment_status_display }}</span>
					{% else %}
						<span class="text-red-600">{{ company.get_payment_status_display }}</span>
					{% endif %}
				</p>
			</div>
		</div>
		
		<!-- Status Summary -->
		{% if company.is_operational %}
		<div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
			<p class="text-sm text-green-800 font-medium">✓ Empresa operacional - pode utilizar todos os recursos</p>
		</div>
		{% else %}
		<div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
			<p class="text-sm text-red-800 font-medium">✗ Empresa não operacional - verifique contrato e status de pagamento</p>
		</div>
		{% endif %}
	</div>
	
	<!-- Dates -->
	<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
		<div class="p-6 rounded-xl glass-effect border border-border/40">
			<p class="text-sm text-muted-foreground">Criada em</p>
			<p class="text-xl font-bold">{{ company.created_at|date:"d/m/Y H:i" }}</p>
		</div>
		<div class="p-6 rounded-xl glass-effect border border-border/40">
			<p class="text-sm text-muted-foreground">Atualizada em</p>
			<p class="text-xl font-bold">{{ company.updated_at|date:"d/m/Y H:i" }}</p>
		</div>
	</div>
	
	<!-- Additional Dates if Available -->
	{% if company.activated_at or company.deactivated_at or company.payment_suspended_at %}
	<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
		{% if company.activated_at %}
		<div class="p-6 rounded-xl glass-effect border border-border/40">
			<p class="text-sm text-muted-foreground">Ativada em</p>
			<p class="text-lg font-medium">{{ company.activated_at|date:"d/m/Y H:i" }}</p>
		</div>
		{% endif %}
		{% if company.deactivated_at %}
		<div class="p-6 rounded-xl glass-effect border border-border/40">
			<p class="text-sm text-muted-foreground">Desativada em</p>
			<p class="text-lg font-medium">{{ company.deactivated_at|date:"d/m/Y H:i" }}</p>
		</div>
		{% endif %}
		{% if company.payment_suspended_at %}
		<div class="p-6 rounded-xl glass-effect border border-border/40">
			<p class="text-sm text-muted-foreground">Suspensa em</p>
			<p class="text-lg font-medium">{{ company.payment_suspended_at|date:"d/m/Y H:i" }}</p>
		</div>
		{% endif %}
	</div>
	{% endif %}
	
	<!-- Notes -->
	{% if company.notes %}
	<div class="p-6 rounded-xl glass-effect border border-border/40">
		<h3 class="text-lg font-semibold mb-2">Observações</h3>
		<p class="text-sm whitespace-pre-wrap">{{ company.notes }}</p>
	</div>
	{% endif %}
	
	<!-- Last Contact for Prospects -->
	{% if company.company_type == 'prospect' and company.contacts.exists %}
	{% with last_contact=company.contacts.first %}
	<div class="p-6 rounded-xl glass-effect border border-border/40">
		<div class="flex items-center justify-between mb-2">
			<h3 class="text-lg font-semibold">Último Contato</h3>
			<a href="{% url 'company_contacts' company.id %}" class="text-sm text-primary hover:underline">
				Ver histórico completo →
			</a>
		</div>
		<p class="text-sm text-muted-foreground mb-2">{{ last_contact.contact_date|date:"d/m/Y H:i" }}</p>
		<p class="text-sm whitespace-pre-wrap">{{ last_contact.notes|truncatewords:30 }}</p>
		{% if last_contact.created_by %}
		<p class="text-xs text-muted-foreground mt-2">
			por {{ last_contact.created_by.get_full_name|default:last_contact.created_by.username }}
		</p>
		{% endif %}
	</div>
	{% endwith %}
	{% endif %}
</div>

<div class="flex items-center justify-between mb-4">
	<h2 class="text-xl font-semibold">Pesquisas</h2>
	<div class="flex items-center gap-3">
		{% include 'components/_page_size.html' with current_page_size=page_size %}
		<a href="{% url 'survey_create' %}" class="px-3 py-2 bg-secondary text-secondary-foreground rounded-lg hover:opacity-90">Nova Pesquisa</a>
	</div>
</div>

<div class="glass-effect rounded-xl border border-border/40 overflow-hidden">
	<table class="min-w-full">
		<thead class="text-left text-sm text-muted-foreground border-b border-border/40">
			<tr>
				<th class="py-3 px-4">Título</th>
				<th class="py-3 px-4">Criado em</th>
				<th class="py-3 px-4"></th>
			</tr>
		</thead>
		<tbody class="divide-y divide-border/40">
			{% for survey in surveys %}
			<tr>
				<td class="py-3 px-4 font-medium">{{ survey.title }}</td>
				<td class="py-3 px-4">{{ survey.created_at }}</td>
				<td class="py-3 px-4 text-right space-x-3">
					<a href="{% url 'survey_detail' survey.id %}" class="text-primary hover:underline">Ver</a>
					<a href="{% url 'survey_update' survey.id %}" class="text-blue-400 hover:underline">Editar</a>
					<a href="{% url 'survey_delete' survey.id %}" class="text-red-400 hover:underline">Excluir</a>
				</td>
			</tr>
			{% empty %}
			<tr>
				<td colspan="3" class="py-6 px-4 text-center text-muted-foreground">Nenhuma pesquisa para esta empresa.</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
</div>
{% include 'components/_pagination.html' with page_obj=page_obj %}
{% endblock %}

